name: Build Application

# åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹è§¦å‘æž„å»ºï¼ŒèŠ‚çœCIèµ„æº
on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# çŽ¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: "3.10"
  BUILD_MODE: "cloud"  # äº‘æ¨¡å¼æž„å»ºï¼Œä¸åŒ…å«æœ¬åœ°Whisperä¾èµ–

jobs:
  # æž„å»ºæ¡ä»¶æ£€æŸ¥
  build-check:
    name: Check Build Conditions
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.changes.outputs.should-build }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Check for relevant changes
      id: changes
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "should-build=true" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" = "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "should-build=true" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" = "push" ] && [[ "${{ github.ref }}" == refs/heads/main || "${{ github.ref }}" == refs/heads/develop ]]; then
          echo "should-build=true" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "should-build=true" >> $GITHUB_OUTPUT
        else
          echo "should-build=false" >> $GITHUB_OUTPUT
        fi

  # Windowsæž„å»º
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    needs: build-check
    if: needs.build-check.outputs.should-build == 'true'

    strategy:
      matrix:
        mode: [cloud]  # åªæž„å»ºäº‘æ¨¡å¼ï¼Œå‡å°‘æž„å»ºæ—¶é—´

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"

    - name: Cache uv dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/uv
        key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-

    - name: Install dependencies (cloud mode only)
      run: |
        uv sync --extra cloud --dev
        # ç§»é™¤æœ¬åœ°Whisperä¾èµ–ä»¥å‡å°æž„å»ºå¤§å°
        uv remove faster-whisper --dev
        uv remove nvidia-cudnn-cu12 nvidia-cublas-cu12 --dev

    - name: Verify icon file exists
      run: |
        if (Test-Path "src/sonicinput/resources/icons/app_icon.ico") {
          Write-Host "Icon file found"
        } else {
          Write-Host "Icon file not found, generating..."
          python scripts/generate_icons.py
        }

    - name: Extract version from pyproject.toml
      id: version
      run: |
        $content = Get-Content "pyproject.toml" -Raw
        if ($content -match 'version\s*=\s*["'']([^"'']+)["'']') {
          $version = $matches[1]
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Found version: $version"
        } else {
          echo "ERROR: Could not extract version from pyproject.toml"
          exit 1
        }

    - name: Build with Nuitka
      run: |
        $version = "${{ steps.version.outputs.version }}"
        uv run nuitka `
          --standalone `
          --onefile `
          --windows-console-mode=disable `
          --enable-plugin=pyside6 `
          --include-package=sonicinput `
          --nofollow-import-to=pytest `
          --nofollow-import-to=mypy `
          --nofollow-import-to=faster_whisper `
          --windows-icon-from-ico=src/sonicinput/resources/icons/app_icon.ico `
          --output-dir=dist `
          --company-name=SonicInput `
          --product-name=SonicInput `
          --file-version=$version `
          --product-version=$version `
          --file-description="Windows Voice Input Tool" `
          --copyright="Copyright (C) 2025" `
          --output-filename=SonicInput-v$version-win64.exe `
          app.py

    - name: Verify build output
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $exeName = "SonicInput-v$version-win64.exe"
        if (Test-Path "dist/$exeName") {
          $size = (Get-Item "dist/$exeName").Length / 1MB
          Write-Host "Build successful! Executable: $exeName"
          Write-Host "Executable size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Error "Build failed - executable not found"
          Get-ChildItem dist/ -Recurse
          exit 1
        }

    - name: Test executable (basic smoke test)
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $exeName = "SonicInput-v$version-win64.exe"
        # æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦èƒ½å¯åŠ¨ï¼ˆéžGUIæ¨¡å¼ï¼‰
        Start-Process -FilePath "dist/$exeName" -ArgumentList "--test" -Wait -PassThru

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sonicinput-windows-${{ matrix.mode }}-v${{ steps.version.outputs.version }}-${{ github.run_number }}
        path: dist/
        retention-days: 30

    - name: Generate release info
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $exeName = "SonicInput-v$version-win64.exe"
        $tag = "${{ github.ref_name }}"
        $size = (Get-Item "dist/$exeName").Length / 1MB
        echo "## ðŸŽ‰ SonicInput $version" > release-info.md
        echo "" >> release-info.md
        echo "### âœ¨ æ–°å¢žåŠŸèƒ½" >> release-info.md
        echo "- ðŸš€ **ç¡…åŸºæµåŠ¨(SiliconFlow)é›†æˆ**: æ–°å¢žå›½å†…é¢†å…ˆçš„AIäº‘è½¬å½•æœåŠ¡æ”¯æŒ" >> release-info.md
        echo "- ðŸŽ¯ **æ™ºèƒ½æœåŠ¡é€‰æ‹©**: è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜è½¬å½•æœåŠ¡ï¼Œç¡®ä¿é«˜ç²¾åº¦å’Œä½Žå»¶è¿Ÿ" >> release-info.md
        echo "- ðŸ”§ **ä¸“ä¸šå¯æ‰§è¡Œæ–‡ä»¶**: é‡‡ç”¨æ–°çš„å‘½åæ ¼å¼ SonicInput-v$version-win64.exe" >> release-info.md
        echo "- ðŸ› ï¸ **å®Œæ•´CI/CDæµç¨‹**: è‡ªåŠ¨åŒ–æµ‹è¯•ã€æž„å»ºå’Œå‘å¸ƒæµç¨‹" >> release-info.md
        echo "" >> release-info.md
        echo "### ðŸ“¦ æž„å»ºä¿¡æ¯" >> release-info.md
        echo "- **ç‰ˆæœ¬**: $version" >> release-info.md
        echo "- **æ ‡ç­¾**: $tag" >> release-info.md
        echo "- **æž„å»ºæ¨¡å¼**: ${{ matrix.mode }}" >> release-info.md
        echo "- **å¯æ‰§è¡Œæ–‡ä»¶**: $exeName" >> release-info.md
        echo "- **æ–‡ä»¶å¤§å°**: $([math]::Round($size, 2)) MB" >> release-info.md
        echo "- **Pythonç‰ˆæœ¬**: ${{ env.PYTHON_VERSION }}" >> release-info.md
        echo "" >> release-info.md
        echo "### ðŸŒŸ ç¡…åŸºæµåŠ¨æœåŠ¡ç‰¹ç‚¹" >> release-info.md
        echo "- ðŸ‡¨ðŸ‡³ **å›½å†…ä¼˜åŒ–**: ä¸“ä¸ºä¸­æ–‡ç”¨æˆ·ä¼˜åŒ–çš„AIè½¬å½•æœåŠ¡" >> release-info.md
        echo "- âš¡ **è¶…ä½Žå»¶è¿Ÿ**: æ¯«ç§’çº§å“åº”ï¼Œå®žæ—¶è¯­éŸ³è½¬æ–‡å­—" >> release-info.md
        echo "- ðŸŽ¯ **é«˜ç²¾åº¦**: ä¸šç•Œé¢†å…ˆçš„è¯­éŸ³è¯†åˆ«å‡†ç¡®çŽ‡" >> release-info.md
        echo "- ðŸ”’ **æ•°æ®å®‰å…¨**: ä¼ä¸šçº§æ•°æ®åŠ å¯†å’Œéšç§ä¿æŠ¤" >> release-info.md

    - name: Upload release info
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: release-info-${{ matrix.mode }}
        path: release-info.md

  # åˆ›å»ºGitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-check, build-windows]
    if: startsWith(github.ref, 'refs/tags/') && needs.build-check.outputs.should-build == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts/

    - name: Extract release info
      run: |
        cat artifacts/release-info-cloud/release-info.md >> release-body.md

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: SonicInput ${{ github.ref_name }}
        body_path: release-body.md
        files: |
          artifacts/sonicinput-windows-cloud-v*-${{ github.run_number }}/*.exe
        draft: false
        prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}